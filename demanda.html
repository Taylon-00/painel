<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DEMANDAS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{--bg:#f5f6f8;--card:#ffffff;--accent:#1f6feb;--ok:#2ea44f;--warn:#ff8c42;--bad:#e55}
    body{font-family:Inter, Roboto, Arial, sans-serif;background:var(--bg);margin:0;color:#222}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(90deg,#f7f7f7,#f0f0f3);box-shadow:0 1px 4px rgba(0,0,0,.06)}
    header .title{display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:18px}
    header img.logo{height:64px}

    .container{padding:18px;max-width:1300px;margin:0 auto}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    .card.large{grid-column:span 8}
    .card.side{grid-column:span 4}
    .kpi{display:flex;gap:12px}
    .kpi .item{flex:1;padding:12px;border-radius:6px;background:linear-gradient(180deg,rgba(0,0,0,0.02),transparent)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    th{font-weight:600;color:#444}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
    .btn{display:inline-block;padding:6px 10px;border-radius:6px;background:var(--accent);color:#fff;text-decoration:none;cursor:pointer}
    .controls{display:flex;gap:10px;align-items:center}
    #map{height:600px;border-radius:6px}
    .row{display:flex;gap:12px}
    .center{text-align:center}
    .small{font-size:12px;color:#666}
    .mayor-photo{width:86px;height:86px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.12)}

    /* Fullscreen toggle for map */
    .map-wrap{position:relative}
    .map-actions{position:absolute;top:10px;right:10px;z-index:600}
    .fullscreen-map{position:fixed!important;top:0;left:0;width:100%!important;height:100%!important;z-index:9999;border-radius:0!important}

    /* Cards for demand types */
    .demand-cards{display:flex;flex-wrap:wrap;gap:10px}
    .demand-card{min-width:180px;padding:12px;border-radius:8px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    .demand-card .count{font-weight:700;font-size:20px}

    /* color-coded rows: we'll set inline style to tr */

    /* responsive */
    @media(max-width:900px){ .grid{grid-template-columns:repeat(6,1fr)} .card.large{grid-column:span 6} .card.side{grid-column:span 6} }

  </style>
</head>
<body>
<header>
  <div class="title">
    <img src="img/SECRETARIA DA PROTEÇÃO SOCIAL - H.png" class="logo" alt="logo" />
    <div>
      <h1>Dashboard de Demandas 2025</h1>
      <div class="small">Interativo • Clique em município, tipo de demanda ou representante</div>
    </div>
  </div>
  <div class="controls">
    <label class="small">Planilha pública (ID):</label>
    <input id="sheetId" style="padding:6px;border-radius:6px;border:1px solid #ccc" value="1d05dIvv7qMlSb4nzIAoE-PZWdXdaanGnqfELgmyLI7o">
    <button id="loadBtn" class="btn">Carregar</button>
  </div>
</header>

<div class="container">
  <div class="grid">
    <div class="card large">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Visão Geral</h3>
        <div class="small">Filtros aplicam-se ao mapa, tabela e cards</div>
      </div>

      <div class="kpi" style="margin-top:12px">
        <div class="item" id="cardTotal">
          <div class="small">Total de demandas</div>
          <div style="font-size:24px;font-weight:700" id="totalCount">—</div>
        </div>
        <div class="item" id="cardCriandoAtendidos">
          <div class="small">Criando Oportunidades (total)</div>
          <div style="font-size:24px;font-weight:700" id="criandoAtendidos">—</div>
        </div>
        <div class="item">
          <div class="small">% Finalizadas</div>
          <div style="font-size:24px;font-weight:700" id="pctFinalizadas">—</div>
        </div>
      </div>

      <div style="margin-top:18px;display:flex;gap:12px;align-items:flex-start">
        <div style="flex:1">
          <canvas id="barChart" height="200"></canvas>
        </div>
        <div style="width:320px">
          <h4 style="margin:0 0 8px 0">Demandas por tipo</h4>
          <div id="demandCards" class="demand-cards"></div>
        </div>
      </div>

    </div>

    <div class="card side">
      <h4 style="margin:0">Mapa por município / bairro</h4>
      <div class="small" style="margin-top:6px">Use a busca para filtrar por município ou bairro</div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <input id="filterInput" placeholder="Buscar município ou bairro..." style="flex:1;padding:8px;border-radius:6px;border:1px solid #ccc" />
        <button id="resetFilter" class="btn" title="Limpar filtros">Limpar</button>
      </div>

      <div style="margin-top:10px" class="map-wrap">
        <div class="map-actions"><button id="toggleFull" class="btn">Tela cheia</button></div>
        <div id="map"></div>
      </div>
    </div>

    <div class="card" style="grid-column:span 8">
      <h4 style="margin:0 0 8px 0">Tabela detalhada</h4>
      <div style="overflow:auto;max-height:480px">
        <table id="dataTable">
          <thead><tr><th>Demanda</th><th>Solicitante</th><th>Município</th><th>Data</th><th>Observação</th><th>Situação</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card side center">
  <div style="display:flex;flex-direction:column;align-items:center;gap:8px" id="mayorCard">
    <img id="mayorPhoto" class="mayor-photo" src="images/mayors/placeholder.png" alt="Prefeito(a)" />
    <div id="mayorName" style="font-weight:700">—</div>
    <div class="small" id="mayorInfo">Foto do prefeito(a) / brasão (procura em /images/mayors)</div>
  </div>
</div>

<button id="btnMoradaNova">Morada Nova</button>

<script>
  document.getElementById('btnMoradaNova').addEventListener('click', function() {
    const photo = document.getElementById('mayorPhoto');
    const name = document.getElementById('mayorName');
    const info = document.getElementById('mayorInfo');

    photo.src = 'img/naiara-castro.jpg'; // deve conter essa imagem na pasta
    photo.alt = 'Prefeita Naiara Castro';

    name.textContent = 'Naiara Carneiro Castro';

    info.innerHTML = `
      Partido: PSB (Partido Socialista Brasileiro) <br>
      Votos: 24.429 (50,88%) <br>
      Vice-prefeito: Rafael Gabáglio <br>
      Total de votos: 49.948 (incluindo 510 brancos, 1422 nulos) <br>
      Abstenção: 12,17% (6.921 eleitores) <br>
      Mandato: 2025 a 2028 <br>
      Profissão: Odontóloga <br>
      Idade: 33 anos (nascida em 03/08/1990)
    `;
  });
</script>


<div><button id="btnPotengi">Potengi</button></div>
<script>
  document.getElementById('btnPotengi').addEventListener('click', function() {
    const photo = document.getElementById('mayorPhoto');
    const name = document.getElementById('mayorName');
    const info = document.getElementById('mayorInfo');

    photo.src = 'img/salviano.png'; // deve conter essa imagem na pasta
    photo.alt = 'Prefeito Salviano Linard de Alencar';

    name.textContent = 'Salviano Linard de Alencar';

    info.innerHTML = `
      Prefeito interino desde 01/01/2025 <br>
      Partido: PDT (Partido Democrático Trabalhista) <br>
      Votos: 4.246 (62,01%) <br>
      Vice-prefeita: Silvaneide Linard de Alencar <br>
      Mandato: 2025 - 2028 <br>
      Profissão: Empresário <br>
      Idade: 35 anos (nascido em 08/04/1990) <br>
      Patrimônio declarado: R$ 10.335.000,00 <br>
      Coligação: Coragem para Mudar (PDT / UNIÃO) <br>
      Endereço do gabinete: Rua José Edmilson Rocha, 135 <br>
      Contato: (88) 3538-1562 / gabinete@potengi.ce.gov.br
    `;
  });
</script>



<div><button id="btnPoranga">Poranga</button></div>
<script>
  document.getElementById('btnPoranga').addEventListener('click', function() {
    const photo = document.getElementById('mayorPhoto');
    const name = document.getElementById('mayorName');
    const info = document.getElementById('mayorInfo');

    photo.src = 'img/Roberto.jpg'; // deve conter essa imagem na pasta
    photo.alt = 'Prefeito Roberto Uchôa';

    name.textContent = 'Roberto Uchôa';

    info.innerHTML = `
      Partido: PT (Partido dos Trabalhadores) <br>
    Votos: 52,98% no 1º turno das eleições 2024 <br>
    Vice-prefeita: Quelma Maria de Abreu Felício <br>
    Mandato: 2025 - 2028 <br>
    Profissão: Empreendedor / Comércio <br>
    Estado civil: Casado com Luiza Ranielly <br>
    Pai do Murilo Uchôa <br>
    Coligação: PT e aliados <br>
    Endereço do gabinete: Prefeitura Municipal de Poranga (site oficial) <br>
    Redes sociais: Instagram @robertouchoaporanga
  `;
  });
</script>





  </div>

  <div style="margin-top:18px;text-align:right" class="small">Gerado para apresentação • Edite cores e textos no cabeçalho</div>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.0/chart.umd.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Configuração
const gid = 0; // aba da planilha
const defaultSheetId = document.getElementById('sheetId').value.trim();

const state = { rows: [], markers: {}, geographyCache: {}, filterText: '' };

// Inicializa mapa
const map = L.map('map').setView([-5.0,-38.5],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);

function sheetCsvUrl(sheetId){ return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`; }

function loadSheet(sheetId){
  const url = sheetCsvUrl(sheetId);
  document.getElementById('loadBtn').textContent = 'Carregando...';
  Papa.parse(url,{download:true,header:true,skipEmptyLines:true,complete:function(results){
    document.getElementById('loadBtn').textContent = 'Carregar';
    state.rows = results.data.map(r=>normalizeRow(r));
    // apply any current filter
    applyFilter(state.filterText);
    buildCards();
    buildCharts();
    placeMunicipalityMarkers();
  },error:function(err){
    alert('Erro ao carregar planilha. Verifique se o arquivo está público e o ID está correto.');
    console.error(err); document.getElementById('loadBtn').textContent = 'Carregar';
  }});
}

function normalizeRow(r){
  const keys = Object.fromEntries(Object.entries(r).map(([k,v])=>[k.trim(),v?.trim?.()||'']));
  const DEMANDA = keys['DEMANDA']||keys['Demanda']||keys['demanda']||'';
  const SOLICITANTE = keys['SOLICITANTE']||keys['Solicitante']||keys['Solicitante ']||'';
  const MUNICIPIO = keys['MUNICÍPIO']||keys['MUNICIPIO']||keys['Municipio']||keys['Município']||keys['MUNICIPIO ' ]||'';
  const BAIRRO = keys['BAIRRO']||keys['Bairro']||keys['bairro']||'';
  const DATA = keys['DATA']||keys['Data']||'';
  const OBS = keys['OBSERVAÇÃO']||keys['OBSERVACAO']||keys['OBSERVACAO']||keys['Observação']||'';
  const SITUACAO = keys['SITUAÇÃO']||keys['SITUACAO']||keys['Situação']||'';
  const ATENDIDO = keys['ATENDIDO']||keys['Atendido']||keys['ATENDIDO?']||'';
  return {DEMANDA,SOLICITANTE,MUNICIPIO,BAIRRO,DATA,OBSERVACAO:OBS,SITUACAO,ATENDIDO};
}

// Build table with color-coded rows and icons
function populateTable(rows){
  const tbody = document.querySelector('#dataTable tbody'); tbody.innerHTML='';
  rows.forEach((r,idx)=>{
    const color = getColorForDemand(r.DEMANDA);
    const tr = document.createElement('tr');
    tr.style.background = color.alpha? `linear-gradient(90deg, ${color.bg}33, transparent)` : '';
    const muniCell = ` <td><span style="display:inline-flex;align-items:center;gap:6px">${locationSVG()}<strong>${r.MUNICIPIO || ''}</strong>${r.BAIRRO?(' — <span class="small">'+r.BAIRRO+'</span>'):''}</span></td>`;
    const dateCell = `<td>${calendarSVG()} ${r.DATA||''}</td>`;
    tr.innerHTML = `<td>${r.DEMANDA}</td><td>${r.SOLICITANTE}</td>${muniCell}${dateCell}<td>${r.OBSERVACAO}</td><td>${r.SITUACAO}</td>`;
    // click on municipality to sync
    tr.querySelector('strong')?.addEventListener('click',()=>{ filterByMunicipio(r.MUNICIPIO); showMunicipalityDetails(r.MUNICIPIO); zoomToMunicipio(r.MUNICIPIO); });
    tbody.appendChild(tr);
  });
}

function locationSVG(){ return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" stroke="#1f6feb" stroke-width="1.6" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>` }
function calendarSVG(){ return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="5" width="18" height="16" rx="2" stroke="#666" stroke-width="1.2" fill="none"/><path d="M16 3v4M8 3v4" stroke="#666" stroke-width="1.2" stroke-linecap="round"/></svg>` }

function getColorForDemand(dem){
  if(!dem) return {bg:'transparent'};
  const key = dem.toLowerCase();
  // map common keywords to colors
  if(key.includes('criando')) return {bg:'#e6f7ff',alpha:true};
  if(key.includes('infra')) return {bg:'#fff4e6',alpha:true};
  if(key.includes('educa')|| key.includes('escola')) return {bg:'#f3ffe6',alpha:true};
  if(key.includes('saúde')|| key.includes('saude')|| key.includes('hospital')) return {bg:'#ffe6f0',alpha:true};
  return {bg:'#f7f7f8'};
}

// Cards: one card per demand type
function buildCards(){
  const counts = {};
  state.rows.forEach(r=>{ const k = (r.DEMANDA||'Sem tipo').trim(); counts[k]=(counts[k]||0)+1 });
  const container = document.getElementById('demandCards'); container.innerHTML='';
  Object.keys(counts).sort((a,b)=>counts[b]-counts[a]).forEach(k=>{
    const card = document.createElement('div'); card.className='demand-card';
    card.innerHTML = `<div style="font-size:13px;color:#666">${k}</div><div class="count">${counts[k]}</div>`;
    card.addEventListener('click',()=>{ applyFilter(k); });
    container.appendChild(card);
  });
  document.getElementById('totalCount').textContent = state.rows.length;
  document.getElementById('criandoAtendidos').textContent = (state.rows.filter(r=> (r.DEMANDA||'').toUpperCase().includes('CRIANDO')).length || 0);
  const finalizadas = state.rows.filter(r=> (r.SITUACAO||'').toLowerCase().includes('finaliz')).length;
  document.getElementById('pctFinalizadas').textContent = state.rows.length? Math.round((finalizadas/state.rows.length)*100)+'%':'—';
}

let barChart;
function buildCharts(){
  const months = {};
  state.rows.forEach(r=>{ const d = r.DATA.split('/'); if(d.length===3){ const m = d[1]; months[m]=(months[m]||0)+1 } });
  const labels = Object.keys(months).sort(); const values = labels.map(k=>months[k]);
  const ctx = document.getElementById('barChart'); if(barChart) barChart.destroy();
  barChart = new Chart(ctx,{type:'bar',data:{labels:labels.map(l=>'Mês '+l),datasets:[{label:'Demandas por mês',data:values}]},options:{plugins:{legend:{display:false}}}});
}

// Geocoding (Nominatim) with cache
async function geocodeMunicipio(muni){
  if(!muni) return null; if(state.geographyCache[muni]) return state.geographyCache[muni];
  const q = encodeURIComponent(muni + ', Ceará, Brasil');
  try{ const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`); const data = await res.json(); if(data && data[0]){ const obj = {lat:parseFloat(data[0].lat),lon:parseFloat(data[0].lon)}; state.geographyCache[muni]=obj; return obj; } }catch(e){console.warn('geocode failed',e)}
  return null;
}

// Place markers filtered by state.filterText
async function placeMunicipalityMarkers(){
  Object.values(state.markers).forEach(m=>map.removeLayer(m)); state.markers={};
  const filtered = filterRows(state.rows, state.filterText);
  const uniqueMunis = [...new Set(filtered.map(r=>r.MUNICIPIO).filter(Boolean))];
  for(const m of uniqueMunis){
    const geo = await geocodeMunicipio(m);
    if(geo){
      const marker = L.circleMarker([geo.lat,geo.lon],{radius:8,fillColor:'#1f6feb',color:'#fff',weight:1,fillOpacity:0.9}).addTo(map);
      marker.bindPopup(`<b>${m}</b><br/>Clique para filtrar`);
      marker.on('click',()=>{ filterByMunicipio(m); showMunicipalityDetails(m); zoomToMunicipio(m); });
      state.markers[m]=marker;
    }
  }
}

function zoomToMunicipio(muni){ if(state.geographyCache[muni]){ map.setView([state.geographyCache[muni].lat,state.geographyCache[muni].lon],11); }}

function filterRows(rows,txt){ if(!txt) return rows; const t = txt.toLowerCase(); return rows.filter(r=> (r.MUNICIPIO||'').toLowerCase().includes(t) || (r.BAIRRO||'').toLowerCase().includes(t) || (r.DEMANDA||'').toLowerCase().includes(t) ); }

function applyFilter(txt){ state.filterText = txt || ''; const filtered = filterRows(state.rows, state.filterText); populateTable(filtered); buildCardsForFiltered(filtered); buildChartsForFiltered(filtered); placeMunicipalityMarkers(); }

function buildCardsForFiltered(filtered){ // update counts on the right panel (small)
  const counts = {}; filtered.forEach(r=>{ const k = (r.DEMANDA||'Sem tipo').trim(); counts[k]=(counts[k]||0)+1 });
  const container = document.getElementById('demandCards'); // highlight matching cards
  Array.from(container.children).forEach(card=>{ const k = card.firstChild.textContent; card.style.opacity = counts[k]? '1':'0.45'; card.querySelector('.count') && (card.querySelector('.count').textContent = counts[k]||0); });
  document.getElementById('totalCount').textContent = state.rows.length;
}

function buildChartsForFiltered(filtered){ // rebuild bar from filtered
  const months = {}; filtered.forEach(r=>{ const d = r.DATA.split('/'); if(d.length===3){ const m = d[1]; months[m]=(months[m]||0)+1 } });
  const labels = Object.keys(months).sort(); const values = labels.map(k=>months[k]);
  if(barChart) barChart.destroy(); const ctx = document.getElementById('barChart'); barChart = new Chart(ctx,{type:'bar',data:{labels:labels.map(l=>'Mês '+l),datasets:[{label:'Demandas por mês',data:values}]},options:{plugins:{legend:{display:false}}}});
}

function filterByMunicipio(muni){ document.getElementById('filterInput').value = muni; applyFilter(muni); }

function showMunicipalityDetails(muni){ document.getElementById('mayorName').textContent = muni || '—';
  const safeName = muni ? muni.toLowerCase().replace(/\s+/g,'_') : 'unknown';
  const paths = [`images/mayors/${safeName}.jpg`,`images/mayors/${safeName}.png`,`images/mayors/${safeName}.jpeg`];
  let found=false; paths.forEach(p=>{ const img = new Image(); img.onload=()=>{ if(!found){document.getElementById('mayorPhoto').src=p; found=true} }; img.onerror=()=>{}; img.src=p; });
  setTimeout(()=>{ if(!found) document.getElementById('mayorPhoto').src='mayor-placeholder.png'; },900)
}

// UI wiring
document.getElementById('loadBtn').addEventListener('click',()=>{ const id = document.getElementById('sheetId').value.trim()||defaultSheetId; loadSheet(id); });

// filter input
const filterInput = document.getElementById('filterInput'); filterInput.addEventListener('input',e=>{ applyFilter(e.target.value); });
document.getElementById('resetFilter').addEventListener('click',()=>{ filterInput.value=''; applyFilter(''); });

// fullscreen toggle
const mapEl = document.getElementById('map'); const wrap = mapEl.parentElement; document.getElementById('toggleFull').addEventListener('click',()=>{
  if(!mapEl.classList.contains('fullscreen-map')){ mapEl.classList.add('fullscreen-map'); document.body.style.overflow='hidden'; document.getElementById('toggleFull').textContent='Sair da tela cheia'; }
  else{ mapEl.classList.remove('fullscreen-map'); document.body.style.overflow=''; document.getElementById('toggleFull').textContent='Tela cheia'; }
  setTimeout(()=>map.invalidateSize(),300);
});

// initial load
loadSheet(defaultSheetId);

</script>
</body>
</html>
